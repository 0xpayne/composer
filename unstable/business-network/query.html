<!doctype html>
<html lang="en">
  
  
  

<head>
  <meta charset="utf-8">
  
    <title>Querying Business Network Data | Hyperledger Composer</title>
  
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/x-icon" href="/composer/unstable/favicon.ico">
  <meta name="google-site-verification" content="fBQRJ6h7MV7_TJ7grbgq4P-d-07NRfDWPe4pqEEoH5w">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  
    <!-- Google Analytics -->
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-91314349-2', 'auto');
ga('require', 'outboundLinkTracker');
ga('require', 'eventTracker');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script async src="/composer/unstable/assets/js/autotrack.js"></script>
<!-- End Google Analytics -->

  

  
    <link href="/composer/unstable/assets/css/normalize.css" rel="stylesheet">
    <link href="/composer/unstable/assets/css/new-style.min.css" rel="stylesheet">
    <link href="/composer/unstable/assets/css/grid-layout.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.6.0/clipboard.min.js"></script>
  
</head>


<body class="">

  
  <!-- % include navbar.html % -->
  

  <div class="SiteWrapper">
    
      <div class="content">
    <article class="docs-container">
        <!-- If there's a sidebar, divide into 2 columns -->
        
        <div class="page-sidebar-grid" id="off-canvas">
          <!-- <a class="toggle close" href="#">close</a> -->
          <div class="docs-pagenav-grid">
            <!-- Navigation -->
  <nav class="navbar-docs" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
            <a class="navbar-brand" href="/composer/unstable/index.html"><b>Hyperledger</b> Composer</a>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <div class="top-nav-docs">
                <!-- <li>
                    <a href="services.html">Composer</a>
                </li> -->
                <!-- <li>
                    <a href="https://composer-playground.mybluemix.net/">Playground</a>
                </li> -->
                    <a href="../tutorials/tutorials.html">Tutorials</a>
                    <a href="../introduction/introduction.html">Docs</a>
                    <a href="../support/index.html">Community</a>
            </div>
        </div>
</nav>

          </div>

          <div class="docs-current-page-grid">
          <p>Querying Business Network Data</p>
          </div>

          <nav class="context-nav">
            
            
              <ul>
<li><p><a href="..//introduction/introduction.html">Introduction</a></p>

<ul>
<li><a href="..//introduction/key-concepts.html">Key Concepts</a></li>
<li><a href="..//introduction/solution-architecture.html">Typical Solution Architecture</a></li>
</ul></li>
<li><p><a href="..//installing/installing-index.html">Installing Index</a></p>

<ul>
<li><a href="..//installing/getting-started-with-playground.html">Using the Playground online</a></li>
<li><a href="..//installing/using-playground-locally.html">Installing the Playground locally</a></li>
<li><a href="..//installing/development-tools.html">Installing a development environment</a></li>
</ul></li>
<li><p><a href="..//tutorials/tutorials.html">Tutorials Index</a></p>

<ul>
<li><a href="..//tutorials/playground-guide.html">Playground Guide</a></li>
<li><a href="..//tutorials/developer-guide.html">Developer Guide</a></li>
</ul></li>
<li><p><a href="..//business-network/business-network-index.html">Developing Business Networks</a></p>

<ul>
<li><a href="..//business-network/businessnetworkdefinition.html">Business Network Definitions</a></li>
<li><a href="..//business-network/bnd-create.html">Create a Business Network Definition</a></li>
<li><a href="..//business-network/bnd-deploy.html">Deploying and Updating Business Networks</a></li>
<li><a href="..//business-network/publishing-events.html">Emitting Events</a></li>
<li><a href="..//business-network/testing.html">Testing Business Networks</a></li>
<li><a href="..//business-network/bnd-publish.html">Publish Models or Business Network Definitions</a></li>
<li><a href="..//business-network/query.html">Querying Business Network Data</a></li>
</ul></li>
<li><p><a href="..//applications/applications-index.html">Developing Applications</a></p>

<ul>
<li><a href="..//applications/node.html">Writing a Node.js application</a></li>
<li><a href="..//applications/web.html">Writing Web or mobile applications</a></li>
<li><a href="..//applications/subscribing-to-events.html">Subscribing to events</a></li>
</ul></li>
<li><p><a href="..//integrating/integrating-index.html">Integrating Index</a></p>

<ul>
<li><a href="..//integrating/getting-started-rest-api.html">Generating a REST API</a></li>
<li><a href="..//integrating/enabling-rest-authentication.html">Enabling REST API authentication for a business network</a></li>
<li><a href="..//integrating/deploying-the-rest-server.html">Deploying the REST server for a business network</a></li>
<li><a href="..//integrating/call-out.html">Calling external REST services</a></li>
<li><a href="..//integrating/node-red.html">Integrating with Node-RED</a></li>
</ul></li>
<li><p><a href="..//managing/managingindex.html">Managing Index</a></p>

<ul>
<li><a href="..//managing/participantsandidentities.html">Participants and identities</a></li>
<li><a href="..//managing/participant-add.html">Adding participants</a></li>
<li><a href="..//managing/identity-issue.html">Issuing an identity to a participant</a></li>
<li><a href="..//managing/identity-revoke.html">Revoking the identity of a participant</a></li>
<li><a href="..//managing/github-oauth.html">Enabling Playground OAuth with GitHub</a></li>
<li><a href="..//managing/current-participant.html">Implementing participant-based access control</a></li>
<li><a href="..//managing/updating-composer.html">Updating Hyperledger Composer</a></li>
</ul></li>
<li><p><a href="..//problems/diagnostics.html">Diagnosing Problems</a></p></li>
<li><p><a href="..//reference/reference-index.html">Reference Index</a></p>

<ul>
<li><a href="..//reference/MeetTheModules.html">Hyperledger Composer npm Modules</a></li>
<li><a href="..//reference/cto_language.html">Modeling Language</a></li>
<li><a href="..//reference/acl_language.html">Access Control Language</a></li>
<li><a href="..//reference/query-language.html">Query Language</a></li>
<li><a href="..//reference/model-compatibility.html">Model Compatibility</a></li>
<li><a href="..//reference/connectionprofile.html">Connection Profiles</a></li>
<li><a href="..//reference/js_scripts.html">Transaction Processor Functions</a></li>
<li><a href="..//reference/commands.html">Hyperledger Composer CLI Commands</a></li>
<li><a href="..//reference/JSDOC-README.html">API Documentation</a></li>
<li><a href="..//reference/glossary.html">Hyperledger Composer Glossary of Terms</a></li>
</ul></li>
<li><p><a href="..//support/.html">Support</a></p></li>
</ul>

            
                <div class="docs-footer-grid">
                <div class="footer-bg-break docs-footer-break">
<div class="footer-container-break">
    <div class="footer-left-break">
      <p>Released under the Apache License v2.0</p>
    </div>
  <div class="footer-right-break">
    <ul>
      <li><a href="https://github.com/hyperledger/composer">GitHub</a></li>
      <!-- <li><a href="https://github.com/hyperledger/composer/LICENSE.txt">Legal</a></li> -->
      <li><a href="/composer/unstable/jsdoc/index.html">APIs</a></li>
      <li><a href="http://stackoverflow.com/questions/tagged/fabric-composer">Stack Overflow</a></li>
      <li><a href="https://goo.gl/forms/7YPMLP2LTN2hjIRk2">Feedback?</a></li>
    </ul>
  </div>
</div>
</div>

                </div>
          </nav>
        </div>
        <div class="page-content-grid">
          <section class="content-chunk">
            <!-- <a class="toggle open" href="#nav">open</a> -->
            
              <h1 id="querying-business-network-data">Querying business network data</h1>

<blockquote>
<p><strong>Warning</strong>: The status of this feature is experimental. You <strong>must</strong> use Hyperledger Composer v0.8+ with the the HLFv1 runtime to use queries. We welcome feedback and comments while we continue to iterate upon query functionality. The API may change based on the feedback received.</p>
</blockquote>

<p>Queries are used to return data about the blockchain world-state; for example, you could write a query to return all drivers over a defined age parameter, or all drivers with a specific name.</p>

<p>Queries are an optional component of a business network definition, written in a single query file (<code>queries.qry</code>).</p>

<p>Note: Queries are supported by the Hyperledger Fabric v1.0, embedded and web runtimes. The query support for the embedded and web runtimes currently has limitations and is unstable. When using the Hyperledger Fabric v1.0-RC runtime Hyperledger Fabric must be configured to use CouchDB persistence. Queries are <strong>not</strong> supported with the Hyperledger Fabric v0.6 runtime.</p>

<h2 id="writing-queries">Writing Queries</h2>

<p>Queries must contain a description and a statement. Query descriptions are a string that describe the function of the query. Query statements contain the operators and functions that control the query behavior.</p>

<p>Query descriptions can be any descriptive string. A query statement must include the <code>SELECT</code> operator and can optionally include <code>FROM</code>, <code>WHERE</code>, <code>AND</code>, <code>ORDER BY</code>, <code>SKIP</code>, and <code>LIMIT</code>.</p>

<p>Queries should take the following format:</p>
<div class="highlight"><pre><code class="language-" data-lang="">query Q1{
  description: "Select all drivers older than 65."
  statement:
      SELECT org.acme.Driver
          WHERE (age&gt;65)
}
</code></pre></div>
<p>For more information on the specifics of the Hyperledger Composer query language, see the <a href="../reference/query-language.html">query language reference documentation</a>.</p>

<h2 id="using-queries">Using Queries</h2>

<p>Queries can be invoked by calling the <em>buildQuery</em> or <em>query</em> APIs. The <em>buildQuery</em> API requires the entire query string to be specified as part of the API input. The <em>query</em> API requires you to specify the name of the query you wish to run.</p>

<p>For more information on the query APIs, see the <a href="../jsdoc/index.html">API documentation</a>.</p>

<h2 id="access-control-for-queries">Access Control for Queries</h2>

<p>When returning the results of a query, your access control rules are applied to the results. Any content which the current user does not have authority to view is stripped from the results.</p>

<p>For example, if the current user sends a query that would return all assets, if they only have authority to view a limited selection of assets, the query would return only that limited set of assets.</p>

<!--- Hyperledger Fabric v1.0 can be configured to store the world-state in a CouchDB database. CouchDB is a JSON document store, so all data in the world-state is persisted as JSON documents, including Composer assets, participants and transactions.

When Hyperledger Fabric is used in CouchDB mode chaincode can execute complex (content-based) queries against the world-state data. The queries are written in the Mango query language, the native CouchDB query language.

An example Mango _selector_ query:
        var q = {
            selector: {
                size: 'SMALL'
            }
        };

This query will select all JSON documents in the document store that contain the property `size` that has the value `SMALL`. Please refer to the CouchDB documentation for the [query syntax for Mango queries](http://docs.couchdb.org/en/2.0.0/api/database/find.html). Note that CouchDB ships with a powerful web interface called [Fauxton](http://couchdb.apache.org/fauxton-visual-guide/). You can use Fauxton to inspect the documents in the document store, run queries, view results etc.

### Running Native CouchDB Mango Queries from Transaction Processor Functions

The Composer runtime API includes the `queryNative(queryString)` method, allowing transaction processor functions to submit native Mango queries to CouchDB. Composer will execute the query against CouchDB, returning a promise to a JS Object that captures the results of running the query.

The JS Object returned is composed of an array of objects, each with a `Key` and `Record` property. `Key` is a string that represents the key of the document in the document store. `Record` is a JS Object that captures the data for the document itself.

### Example

The example below runs a content-based query to select all `SMALL` marbles, verifies the number of marbles returned, and that they are indeed all `SMALL`.

```
/**
 * Executes a CouchDB query and checks the results.
 * @param {org.fabric_composer.marbles.QueryMarbleByOwner} transaction
 * @transaction
 * @return {Promise} a promise to the results of transaction processing
 */
function onQueryMarbleByOwner(transaction) {
    var factory = getFactory();
    // create the query
    var q = {
        selector: {
            size: 'SMALL'
        }
    };
    return queryNative(JSON.stringify(q))
        .then(function (resultArray) {
            print('TP function received query result: ', JSON.stringify(resultArray));
            if (resultArray.length !== 5) {
                throw new Error('The incorrect number of marbles found: ', resultArray.length);
            }
            for (var x = 0; x < resultArray.length; x++) {
                var currentResult = resultArray[x];
                if (currentResult.Record.size !== 'SMALL') {
                    throw new Error('Query returned a marble that is not SMALL!', currentResult.Record);
                }
            }
        });
}
```

Using a selector it is possible to query all assets of a given type, with a given set of properties, and then to convert them back into Composer resources using `getSerializer().fromJSON(jsObject)`. Once the JS object returned by a query have been converted back into a Composer object it can be updated and persisted back into an asset registry.

>Note that in the future Composer will define a query language expressed in terms of assets, participants and transactions and automatically marshal the JS objects returned by CouchDB to the corresponding Composer modeled types.
-->

            
          </section>
        </div>
        <!-- Otherwise, have the main content fill all 12 columns... -->
        
      <div class="PageNavigation">
    
    
  </div>
    </article>
</div>
<script>
(function (document) {
    function clipboard_init() {
        var charts = document.querySelectorAll("div.highlight"),
            arr = [],
            i, j, maxItem, pre, btn, el;

        // Make sure we are dealing with an array
        for(i = 0, maxItem = charts.length; i < maxItem; i++) arr.push(charts[i]);

        // Find the UML source element and get the text
        for (i = 0, maxItem = arr.length; i < maxItem; i++) {
            el = arr[i];
            pre = el.childNodes[0];

            pre.id = "hl_code" + i.toString();
            btn = document.createElement('copy-button');
            btn.appendChild(document.createTextNode('Copy'));
            btn.setAttribute("class", "copy-btn");
            btn.setAttribute("data-clipboard-target", "#hl_code" + i.toString());
            el.insertBefore(btn, pre);
        }
        new Clipboard('.copy-btn');
    };

    function onReady(fn) {
        if (document.addEventListener) {
            document.addEventListener('DOMContentLoaded', fn);
        } else {
            document.attachEvent('onreadystatechange', function() {
                if (document.readyState === 'interactive')
                    fn();
            });
        }
    }

    onReady(function(){
        clipboard_init();
    });
})(document);
</script>
<script src="/composer/unstable/assets/js/nav.js"></script>

    

    


  </div>
</body>
</html>
