<!doctype html>
<html lang="en">
  
  
  

<head>
  <meta charset="utf-8">
  
    <title>Querying Business Network Data | Hyperledger Composer</title>
  
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/x-icon" href="/composer/unstable/favicon.ico">
  <meta name="google-site-verification" content="fBQRJ6h7MV7_TJ7grbgq4P-d-07NRfDWPe4pqEEoH5w">
  <link href="//fonts.googleapis.com/css?family=Roboto+Slab:400,700%7CRoboto:400,700,700italic,400italic" rel="stylesheet" type="text/css">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
   <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
  <script src="/composer/unstable/assets/js/clipboard.min.js"></script>

  
    <!-- Google Analytics -->
<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-91314349-2', 'auto');
ga('require', 'outboundLinkTracker');
ga('require', 'eventTracker');
ga('send', 'pageview');
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script async src="/composer/unstable/assets/js/autotrack.js"></script>
<!-- End Google Analytics -->

  

  
    <link href="/composer/unstable/assets/css/normalize.css" rel="stylesheet">
    <link href="/composer/unstable/assets/css/main.css" rel="stylesheet">
    <link href="/composer/unstable/assets/css/footer.css" rel="stylesheet">
    <link href="/composer/unstable/assets/css/prettify.css" rel="stylesheet">
    <link href="/composer/unstable/assets/css/bootstrap.css" rel="stylesheet">
    <link href="/composer/unstable/assets/css/composer-style.css" rel="stylesheet">
    <link href="/composer/unstable/assets/css/new-style.min.css" rel="stylesheet">
  
</head>


<body class="">

  
  <!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/composer/unstable/index.html"><b>Hyperledger</b> Composer</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- <li>
                    <a href="services.html">Composer</a>
                </li> -->
                <!-- <li>
                    <a href="https://composer-playground.mybluemix.net/">Playground</a>
                </li> -->
                <li>
                    <a href="../tutorials/tutorials.html">Tutorials</a>
                </li>
                <li>
                    <a href="../introduction/introduction.html">Docs</a>
                </li>
                <li>
                    <a href="../support/index.html">Community</a>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container
   -->
</nav>

  

  <div class="SiteWrapper">
    
      <div class="content">
    <article class="container">
      <div class="row">
        <!-- If there's a sidebar, divide into 2 columns -->
        
        <div class="col-md-3">
          <nav class="context-nav" id="myScrollspy">
            
            
              <p><strong><a href="../introduction/introduction.html">Introduction</a></strong>
<strong><a href="../installing/installing-index.html">Installing</a></strong>
<strong><a href="../tutorials/tutorials.html">Tutorials</a></strong>
<strong><a href="../business-network/business-network-index.html">Developing Business Networks</a></strong>
<a href="../business-network/businessnetworkdefinition.html">What is a business network definition?</a>
<a href="../business-network/bnd-create.html">Creating a business network definition</a>
<a href="../business-network/bnd-deploy.html">Deploying and updating</a>
<a href="../business-network/publishing-events.html">Emitting events</a>
<a href="../business-network/testing.html">Testing</a>
<a href="../business-network/bnd-publish.html">Publishing to npm</a>
<a href="../business-network/query.html">Querying business network data</a>
<strong><a href="../applications/applications-index.html">Developing Applications</a></strong>
<strong><a href="../integrating/integrating-index.html">Integrating Existing Systems</a></strong>
<strong><a href="../managing/managingindex.html">Managing and Operating</a></strong>
<strong><a href="../problems/diagnostics.html">Diagnosing Problems</a></strong>
<strong><a href="../reference/reference-index.html">Reference</a></strong>
<strong><a href="../support/index.html">Support</a></strong></p>

            
          </nav>
        </div>
        <div class="col-md-9">
          <section class="content-chunk">
            
              <h1 id="querying-business-network-data">Querying business network data</h1>

<blockquote>
<p>Warning
The status of this feature is experimental. You <strong>must</strong> use Hyperledger Composer v0.8+ with the the HLFv1 runtime to use queries. We welcome feedback and comments while we continue to iterate upon query functionality. The API may change based on the feedback received. In future releases we plan to extend this feature with a Composer specific query language, and data-binding to assets, participants and transactions.</p>
</blockquote>

<p>Hyperledger Fabric v1.0 can be configured to store the world-state in a CouchDB database. CouchDB is a JSON document store, so all data in the world-state is persisted as JSON documents, including Composer assets, participants and transactions.</p>

<p>When Hyperledger Fabric is used in CouchDB mode chaincode can execute complex (content-based) queries against the world-state data. The queries are written in the Mango query language, the native CouchDB query language.</p>

<p>An example Mango <em>selector</em> query:
        var q = {
            selector: {
                size: &#39;SMALL&#39;
            }
        };</p>

<p>This query will select all JSON documents in the document store that contain the property <code>size</code> that has the value <code>SMALL</code>. Please refer to the CouchDB documentation for the <a href="http://docs.couchdb.org/en/2.0.0/api/database/find.html">query syntax for Mango queries</a>. Note that CouchDB ships with a powerful web interface called <a href="http://couchdb.apache.org/fauxton-visual-guide/">Fauxton</a>. You can use Fauxton to inspect the documents in the document store, run queries, view results etc.</p>

<h3 id="running-native-couchdb-mango-queries-from-transaction-processor-functions">Running Native CouchDB Mango Queries from Transaction Processor Functions</h3>

<p>The Composer runtime API includes the <code>queryNative(queryString)</code> method, allowing transaction processor functions to submit native Mango queries to CouchDB. Composer will execute the query against CouchDB, returning a promise to a JS Object that captures the results of running the query.</p>

<p>The JS Object returned is composed of an array of objects, each with a <code>Key</code> and <code>Record</code> property. <code>Key</code> is a string that represents the key of the document in the document store. <code>Record</code> is a JS Object that captures the data for the document itself.</p>

<h3 id="example">Example</h3>

<p>The example below runs a content-based query to select all <code>SMALL</code> marbles, verifies the number of marbles returned, and that they are indeed all <code>SMALL</code>.</p>
<div class="highlight"><pre><code class="language-" data-lang="">/**
 * Executes a CouchDB query and checks the results.
 * @param {org.fabric_composer.marbles.QueryMarbleByOwner} transaction
 * @transaction
 * @return {Promise} a promise to the results of transaction processing
 */
function onQueryMarbleByOwner(transaction) {
    var factory = getFactory();
    // create the query
    var q = {
        selector: {
            size: 'SMALL'
        }
    };
    return queryNative(JSON.stringify(q))
        .then(function (resultArray) {
            print('TP function received query result: ', JSON.stringify(resultArray));
            if (resultArray.length !== 5) {
                throw new Error('The incorrect number of marbles found: ', resultArray.length);
            }
            for (var x = 0; x &lt; resultArray.length; x++) {
                var currentResult = resultArray[x];
                if (currentResult.Record.size !== 'SMALL') {
                    throw new Error('Query returned a marble that is not SMALL!', currentResult.Record);
                }
            }
        });
}
</code></pre></div>
<p>Using a selector it is possible to query all assets of a given type, with a given set of properties, and then to convert them back into Composer resources using <code>getSerializer().fromJSON(jsObject)</code>. Once the JS object returned by a query have been converted back into a Composer object it can be updated and persisted back into an asset registry.</p>

<blockquote>
<p>Note that in the future Composer will define a query language expressed in terms of assets, participants and transactions and automatically marshall the JS objects returned by CouchDB to the corresponding Composer modelled types.</p>
</blockquote>

            
          </section>
        </div>
        <!-- Otherwise, have the main content fill all 12 columns... -->
        
      </div>
      <div class="PageNavigation">
    
    
  </div>
    </article>
</div>

    

    
      <div class="footer-bg docs-footer">
<div class="footer-container">
    <div class="footer-left">
      <p>Released under the Apache License v2.0</p>
    </div>
  <div class="footer-right">
    <ul>
      <li><a href="https://github.com/hyperledger/composer">GitHub</a></li>
      <!-- <li><a href="https://github.com/hyperledger/composer/LICENSE.txt">Legal</a></li> -->
      <li><a href="/composer/unstable/jsdoc/index.html">APIs</a></li>
      <li><a href="http://stackoverflow.com/questions/tagged/fabric-composer">Stack Overflow</a></li>
      <li><a href="https://goo.gl/forms/7YPMLP2LTN2hjIRk2">Feedback?</a></li>
    </ul>
  </div>
</div>
</div>

    


  </div>
</body>

<!-- jQuery -->
<script src="/composer/unstable/assets/js/jquery.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/composer/unstable/assets/js/bootstrap.js"></script>

<script>

  $( document ).ready(function() {

      new Clipboard('.btn', {
    text: function() {

        return document.querySelector("[style='display:none;']").value;
    }
});
  });

</script>

</html>
